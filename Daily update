terraform {
  required_version = ">= 1.5.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = ">= 5.40"
    }
  }
}

locals {
  tags = merge(
    {
      Module = "aws_guardduty_s3"
    },
    var.tags
  )
}

# Create GuardDuty detector (main component)
resource "aws_guardduty_detector" "this" {
  enable                       = true
  finding_publishing_frequency  = var.finding_publishing_frequency
  tags                         = local.tags
}

# Optional: Organization-wide setup (only if needed)
resource "aws_guardduty_organization_admin_account" "this" {
  count            = var.org_enable ? 1 : 0
  admin_account_id = var.org_admin_account_id
}

resource "aws_guardduty_organization_configuration" "this" {
  count       = var.org_enable ? 1 : 0
  detector_id = aws_guardduty_detector.this.id
  auto_enable = var.org_auto_enable_members

  depends_on = [aws_guardduty_organization_admin_account.this]
}

# Include S3 configuration (defined separately in s3.tf)
module "s3_protection" {
  source      = "./"
  depends_on  = [aws_guardduty_detector.this]
}
